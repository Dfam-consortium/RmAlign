#!/usr/bin/env python3
"""
RepeatMasker front-end for RmAlign:

- Normalizes key paths (sequence, project_dir, lib_file/library)
- Requires at least one of: --species OR --lib_file/--library
- Forwards unknown args to Nextflow unchanged
- Runs main.nf relative to this script's directory
"""

import argparse
import os
import sys
import subprocess
from pathlib import Path
from typing import List, Tuple


def _abs_path(p: str | os.PathLike | None) -> str | None:
    if p is None:
        return None
    return str(Path(os.path.expandvars(str(p))).expanduser().resolve(strict=False))


def parse_args() -> Tuple[argparse.Namespace, List[str]]:
    p = argparse.ArgumentParser(
        prog="RepeatMasker",
        description="RmAlign front-end that prepares a project dir and calls Nextflow."
    )

    # Inputs we will canonicalize
    p.add_argument("--sequence", required=True, help="Input FASTA")
    p.add_argument("--project_dir", required=True, help="Project work directory")

    # Either species OR a library must be provided (enforced manually)
    p.add_argument("--species", help="Species (Dfam/RepeatMasker species tag)")
    p.add_argument("--lib_file", help="Custom repeat library FASTA")
    p.add_argument("--library", help="Alias for --lib_file")

    args, passthrough = p.parse_known_args()

    # Validate either species or library given
    if not (args.species or args.lib_file or args.library):
        print("ERROR: Either --species OR --lib_file/--library must be provided.", file=sys.stderr)
        sys.exit(2)

    return args, passthrough


def main() -> int:
    args, passthrough = parse_args()

    # Normalize key paths
    lib_val = args.lib_file if args.lib_file else args.library
    sequence_abs = _abs_path(args.sequence)
    project_abs  = _abs_path(args.project_dir)
    lib_abs      = _abs_path(lib_val) if lib_val else None

    # Ensure project directory exists
    os.makedirs(project_abs, exist_ok=True)

    # Update args so downstream code sees absolute values
    args.sequence = sequence_abs
    args.project_dir = project_abs
    if lib_abs:
        args.lib_file = lib_abs
        args.library = lib_abs

    # Resolve main.nf relative to this script
    script_dir = Path(__file__).resolve().parent
    main_nf = str((script_dir / "main.nf").resolve())

    # Build Nextflow command
    nf_cmd = [
        "nextflow", "run", main_nf,
        "--sequence", sequence_abs,
        "--project_dir", project_abs,
    ]

    if args.species:
        nf_cmd += ["--species", args.species]
    if lib_abs:
        nf_cmd += ["--lib_file", lib_abs]

    # Forward unknown args to Nextflow as-is
    nf_cmd += passthrough

    try:
        proc = subprocess.run(nf_cmd, check=False)
        return proc.returncode
    except FileNotFoundError:
        print("ERROR: nextflow not found on PATH", file=sys.stderr)
        return 127


if __name__ == "__main__":
    raise SystemExit(main())

